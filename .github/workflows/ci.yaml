name: Pull Request Workflow
on:
  pull_request:
    branches: [ main ]
jobs:
  api-ci:
    name: API CI Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      DOCKER_CMD: docker-compose -f ./apps/api/docker-compose.yml
      DOCKER_EXEC: docker-compose -f ./apps/api/docker-compose.yml run app
      NODE_ENV: testing
      CI: true
      PORT: 3000
      DATABASE_URL: postgres://developer@db:5432/home-automation-helper
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      TEST_HOST: 127.0.0.1
    
    steps:
    - name: Setup - Checkout code
      uses: actions/checkout@v1

    - uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'

    - name: Install dependencies
      run: npm i -ws

    - name: Build Packages
      run: npm run build

    - name: Start db containers
      run: "${DOCKER_CMD} up -d"

    - name: Typecheck
      run: "cd apps/api && npm run typecheck"

    - name: Lint
      run: "cd apps/api && npm run lint"

    - name: Setup Test DB
      run: "cd apps/api && npx prisma migrate deploy"

    - name: Seed Test DB
      run: "cd apps/api && npm run db:seed"

    - name: Unit Tests
      run: "cd apps/api && npm run test:unit"

    - name: API Tests
      run: "cd apps/api && npm run test:api"

    - name: Stop containers
      if: always()
      run: "${DOCKER_CMD} down"
